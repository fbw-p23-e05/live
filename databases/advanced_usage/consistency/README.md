# Transactions

A transaction is a unit of work that is performed against a database. Transactions are units or sequences of work accomplished in a logical order, whether in a manual fashion by a user or automatically by some sort of a database program.

A transaction is the propagation of one or more changes to the database. For example, if you are creating a record, updating a record, or deleting a record from the table, then you are performing transaction on the table. It is important to control transactions to ensure data integrity and to handle database errors.

Practically, you will club many PostgreSQL queries into a group and you will execute all of them together as a part of a transaction.

## Properties of Transactions

Transactions have the following four standard properties, usually referred to by the acronym ACID −

* **Atomicity** − Ensures that all operations within the work unit are completed successfully; otherwise, the transaction is aborted at the point of failure and previous operations are rolled back to their former state.

* **Consistency** − Ensures that the database properly changes states upon a successfully committed transaction.

* **Isolation** − Enables transactions to operate independently of and transparent to each other.

* **Durability** − Ensures that the result or effect of a committed transaction persists in case of a system failure.

## Transaction Control

The following commands are used to control transactions −

* `BEGIN TRANSACTION` − To start a transaction.

* `COMMIT` − To save the changes, alternatively you can use `END TRANSACTION` command.

* `ROLLBACK` − To rollback the changes.

Transactional control commands are only used with the DML commands `INSERT`, `UPDATE` and `DELETE` only. They cannot be used while creating tables or dropping them because these operations are automatically committed in the database.

**The `BEGIN TRANSACTION` Command**

Transactions can be started using `BEGIN TRANSACTION` or simply `BEGIN` command. Such transactions usually persist until the next `COMMIT` or `ROLLBACK`command is encountered. But a transaction will also `ROLLBACK` if the database is closed or if an error occurs.

The following is the simple syntax to start a transaction −

```sql
BEGIN;

--or

BEGIN TRANSACTION;
```

**The `COMMIT` Command**

The `COMMIT` command is the transactional command used to save changes invoked by a transaction to the database.

The `COMMIT` command saves all transactions to the database since the last `COMMIT` or `ROLLBACK` command.

The syntax for `COMMIT` command is as follows −

```sql
COMMIT;

--or

END TRANSACTION;
```

**The `ROLLBACK` Command**

The `ROLLBACK` command is the transactional command used to undo transactions that have not already been saved to the database.

The `ROLLBACK` command can only be used to undo transactions since the last `COMMIT` or `ROLLBACK` command was issued.

The syntax for `ROLLBACK` command is as follows −

```sql
ROLLBACK;
```

## Setting up a sample table

Let’s create a new table named accounts for the demonstration:

```sql
DROP TABLE IF EXISTS accounts;

CREATE TABLE accounts (
    id INT GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(100) NOT NULL,
    balance DEC(15,2) NOT NULL,
    PRIMARY KEY(id)
);
```

1. **Begin a transaction**

    When you execute the following `INSERT` statement:

    ```sql
    INSERT INTO accounts(name,balance)
    VALUES('Bob',10000);
    ```
    
    PostgreSQL inserted a new row into the accounts table immediately. In this case, you do not know when the transaction begins and cannot intercept the modification such as rolling it back.

    To start a transaction, you use the following statement:

    ```sql
    BEGIN TRANSACTION;
    
    -- or

    BEGIN WORK;
    
    -- or just:

    BEGIN;
    ```

    For example, the following statements start a new transaction and insert a new account into the accounts table:

    ```sql
    BEGIN;

    INSERT INTO accounts(name, balance)
    VALUES('Alice', 10000);
    ```

    From the current session, you can see the change by querying the accounts table:

    ```sql
    SELECT *
    FROM accounts;
    ```

    However, if you start a new session and execute the query above, you will not see the change.

    ```sql
    SELECT *
    FROM accounts;
    ```

2. **Commit a transaction**

    To make the change visible to other sessions (or users) you need to commit the transaction by using the `COMMIT WORK` statement:

    ```sql
    COMMIT WORK;

    -- or

    COMMIT TRANSACTION;

    -- or simply:

    COMMIT;
    ```

    The following `COMMIT `statement inserts Alice’s account to the accounts table:

    ```sql
    COMMIT;
    ```
    
    From other sessions, you can view the change by querying the accounts table:

    ```sql
    SELECT *
    FROM accounts;
    ```
    
    After executing the `COMMIT` statement, PostgreSQL also guarantees that the change will be durable if a crash happens.

    Put it all together.

    ```sql
    -- start a transaction
    BEGIN;

    -- insert a new row into the accounts table
    INSERT INTO accounts(name,balance)
    VALUES('Alice',10000);

    -- commit the change (or roll it back later)
    COMMIT;
    ```

    **PostgreSQL COMMIT: Bank account transfer example**

    In this demonstration, we will show you how to transfer 1000 USD from Bob’s account to Alice’s account. We will use two sessions for viewing the change in each operation.

    In the first session, start a new transaction:

    ```sql
    BEGIN;
    ```
    
    and subtracting 1000 USD from Bob’s account with id 1:

    ```sql
    UPDATE accounts 
    SET balance = balance - 1000
    WHERE id = 1;
    ```
    
    In the second session, check the account balance of both accounts:

    ```sql
    SELECT *
    FROM accounts;
    ```

    As you can see, the change is not visible in other sessions.

    Next, add the same amount (1000USD ) to Alice’s account:

    ```sql
    UPDATE accounts
    SET balance = balance + 1000
    WHERE id = 2;
    ```
    
    This change also is not visible to the second session until we commit it:

    ```sql
    COMMIT;
    ```
    
    Now, you can view the change from any session:

    ```sql
    SELECT *
    FROM accounts;
    ```
    
    Put it all together.

    ```sql
    -- start a transaction
    BEGIN;

    -- deduct 1000 from account 1
    UPDATE accounts 
    SET balance = balance - 1000
    WHERE id = 1;

    -- add 1000 to account 2
    UPDATE accounts
    SET balance = balance + 1000
    WHERE id = 2; 

    -- select the data from accounts
    SELECT id, name, balance
    FROM accounts;

    -- commit the transaction
    COMMIT;
    ```
    
3. **Rolling back a transaction**

    To roll back or undo the change of the current transaction, you use any of the following statements:

    ```sql
    ROLLBACK WORK;
    
    -- or

    ROLLBACK TRANSACTION;
    
    -- or in short:

    ROLLBACK;
    ```
    
    Suppose, you want to transfer 1500 USD from Bob’s account to Alice’s account. However, you accidentally send the money to Jack’s account instead of Alice’s. And you want to roll back the whole transaction.

    First, add Jack’s account to the accounts table:

    ```sql
    INSERT INTO accounts(name, balance)
    VALUES('Jack',0);
    ```   
    
    Next, subtract an amount from Bob’s account:

    ```sql
    BEGIN;

    UPDATE accounts 
    SET balance = balance - 1500
    WHERE id = 1;
    ```
    
    Then, adding the same amount to Alice’s account:

    ```sql
    UPDATE accounts
    SET balance = balance + 1500
    WHERE id = 3;
    ``` 

    However, Alice’s account has id 2. So this was a mistake.

    To undo the change, you execute the `ROLLBACK` statement:

    ```sql
    ROLLBACK;
    ```
    
    Finally, check the balances of all accounts:

    ```sql
    SELECT *
    FROM accounts;
    ```
    
    **PostgreSQL Transaction - Rollback example**

    As shown clearly in the output, the account balances remain the same as they were before the transaction.

    Put it all together.

    ```sql
    -- begin the transaction
    BEGIN;

    -- deduct the amount from the account 1
    UPDATE accounts 
    SET balance = balance - 1500
    WHERE id = 1;

    -- add the amount from the account 3 (instead of 2)
    UPDATE accounts
    SET balance = balance + 1500
    WHERE id = 3; 

    -- roll back the transaction
    ROLLBACK;
    ```